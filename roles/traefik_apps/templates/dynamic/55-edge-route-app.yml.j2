# Managed by Ansible (traefik_app)
# App: {{ edge_app.name }}

{% set ns = (edge_app._ns | default('default')) | lower %}
{% set default_ns = (traefik_apps_default_namespace | default('default')) | lower %}
{% set app_id = (ns != default_ns) | ternary(ns ~ '-' ~ edge_app.name, edge_app.name) %}

{% set fqdn = edge_app.fqdn %}
{% set redirect_http = edge_app.redirect_http | default(true) %}
{% set backend_url = edge_app.backend_url %}

http:
  routers:
{% if redirect_http %}
    {{ app_id }}-http:
      rule: "Host(`{{ fqdn }}`)"
      entryPoints: [ "http" ]
      middlewares: [ "redirect-to-https" ]
      service: noop@internal
{% endif %}
    {{ app_id }}:
      rule: "Host(`{{ fqdn }}`)"
      entryPoints: [ "https" ]
      tls: {}
      service: "{{ app_id }}"

  services:
    {{ app_id }}:
      loadBalancer:
        passHostHeader: true
        servers:
          - url: "{{ backend_url }}"