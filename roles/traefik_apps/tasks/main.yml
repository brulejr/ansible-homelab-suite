- name: Traefik Apps | Ensure traefik dynamic dir exists
  ansible.builtin.file:
    path: "{{ traefik_dynamic_dir }}"
    state: directory
    mode: "0755"

# 1) Render the common baseline first
- name: Traefik Apps | Render common edge routes file
  ansible.builtin.template:
    src: "50-edge-route-common.yml.j2"
    dest: "{{ traefik_dynamic_dir }}/50-edge-route-common.yml"
    mode: "0644"
  notify: restart traefik

# 2) Build a flat list of all edge apps from backend hosts
- name: Traefik Apps | Build edge apps list from inventory
  ansible.builtin.set_fact:
    traefik_edge_apps_flat: >-
      {{
        (traefik_edge_apps_flat | default([])) +
        (
          (hostvars[h].edge_apps | default([]))
          | map('combine', {
              'owner_host': h,
              'target_ip': (hostvars[h].server_bind_ip | default('')),
              'router_name': (h ~ '-' ~ item_name_placeholder),
              'service_name': (h ~ '-' ~ item_name_placeholder)
            })
          | list
        )
      }}
  vars:
    # Jinja can't reference the current mapped item directly inside map('combine'),
    # so we patch names in a follow-up task below.
    item_name_placeholder: "__APP__"
  loop: "{{ groups['all'] }}"
  when: hostvars[h] is defined
  loop_control:
    loop_var: h
  run_once: true

# 2b) Normalize router/service names and validate required fields
- name: Traefik Apps | Normalize edge app items and validate
  ansible.builtin.set_fact:
    traefik_edge_apps: "{{ traefik_edge_apps | default([]) + [ normalized ] }}"
  vars:
    normalized:
      owner_host: "{{ item.owner_host }}"
      name: "{{ item.name }}"
      fqdn: "{{ item.fqdn }}"
      port: "{{ item.port }}"
      scheme: "{{ item.scheme | default('http') }}"
      target_ip: "{{ item.target_ip }}"
      middlewares: "{{ item.middlewares | default([]) }}"
      cert_resolver: "{{ item.cert_resolver | default('cloudflare') }}"
      router_name: "{{ item.owner_host }}-{{ item.name }}"
      service_name: "{{ item.owner_host }}-{{ item.name }}"
  loop: "{{ traefik_edge_apps_flat | default([]) }}"
  when: item.target_ip | length > 0
  run_once: true

- name: Traefik Apps | Fail if any edge app is missing required fields
  ansible.builtin.assert:
    that:
      - item.name is defined
      - item.fqdn is defined
      - item.port is defined
      - item.target_ip is defined
      - item.target_ip | length > 0
    fail_msg: "Invalid edge app entry: {{ item }}"
  loop: "{{ traefik_edge_apps | default([]) }}"
  run_once: true

# 3) (Recommended) prune old per-app route files to avoid stale routes
- name: Traefik Apps | Find existing per-app edge route files
  ansible.builtin.find:
    paths: "{{ traefik_dynamic_dir }}"
    patterns: "55-edge-route-*.yml"
  register: edge_route_files

- name: Traefik Apps | Remove existing per-app edge route files
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ edge_route_files.files }}"
  notify: restart traefik

# 4) Render one file per app
- name: Traefik Apps | Render per-app edge route files
  ansible.builtin.template:
    src: "dynamic/55-edge-route-app.yml.j2"
    dest: "{{ traefik_dynamic_dir }}/55-edge-route-{{ item.owner_host }}-{{ item.name }}.yml"
    mode: "0644"
  loop: "{{ traefik_edge_apps | default([]) }}"
  loop_control:
    label: "{{ item.owner_host }}:{{ item.name }}"
  notify: restart traefik
