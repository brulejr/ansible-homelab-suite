---
# roles/traefik_app/tasks/edge_routes.yml
#
# Generates Traefik dynamic edge route config in parts:
#  - 50-edge-route-common.yml      (middlewares only)
#  - 55-edge-route-<app>.yml       (one router+service per app)
#
# App definitions are sourced from inventory group_vars/*_servers.yml files
# as a flattened list: edge_apps: [ {name,fqdn,backend_url,...}, ... ]
#
# NOTE: Since filenames are based on edge_apps.name, names must be globally unique.

- name: Ensure Traefik dynamic config directory exists
  ansible.builtin.file:
    path: "{{ traefik_dynamic_dir }}"
    state: directory
    mode: "0755"

# 1) Common middleware definitions
- name: Render common edge route middlewares
  ansible.builtin.template:
    src: "dynamic/50-edge-route-common.yml.j2"
    dest: "{{ traefik_dynamic_dir }}/50-edge-route-common.yml"
    mode: "0644"
  notify: restart traefik

# 2) Determine which inventory groups contribute edge apps.
#    By default, include any group ending with "_servers".
#    You may override with traefik_edge_route_groups in inventory.
- name: Determine route source groups
  ansible.builtin.set_fact:
    _edge_route_groups: >-
      {{
        (traefik_edge_route_groups | default([]))
        if (traefik_edge_route_groups | default([]) | length > 0)
        else (groups | dict2items | map(attribute='key') | select('match', '.*_servers$') | list)
      }}
  run_once: true

# 3) Collect edge_apps ONCE per group (not once per host).
#    Because group_vars apply to all hosts, using a representative host avoids duplication.
- name: Initialize aggregated edge apps list
  ansible.builtin.set_fact:
    traefik_edge_apps_all: []
  run_once: true

- name: Collect edge apps from group_vars via representative host
  ansible.builtin.set_fact:
    traefik_edge_apps_all: >-
      {{
        traefik_edge_apps_all
        + (hostvars[groups[item][0]].edge_apps | default([]))
      }}
  loop: "{{ _edge_route_groups }}"
  when:
    - groups[item] is defined
    - (groups[item] | length) > 0
  run_once: true

# Optional: strip accidental nulls
- name: Remove null entries from aggregated edge apps list
  ansible.builtin.set_fact:
    traefik_edge_apps_all: "{{ traefik_edge_apps_all | reject('equalto', None) | list }}"
  run_once: true

# 4) Validate required fields
- name: Validate edge apps have required fields
  ansible.builtin.assert:
    that:
      - item.name is defined
      - item.name | length > 0
      - item.fqdn is defined
      - item.fqdn | length > 0
      - item.backend_url is defined
      - item.backend_url | length > 0
    fail_msg: "Invalid edge app entry: {{ item }}"
  loop: "{{ traefik_edge_apps_all }}"
  run_once: true

# 5) Ensure unique names (filenames are based on name)
- name: Ensure edge app names are globally unique
  ansible.builtin.assert:
    that:
      - (traefik_edge_apps_all | map(attribute='name') | list | length)
        ==
        (traefik_edge_apps_all | map(attribute='name') | list | unique | length)
    fail_msg: "Duplicate edge_apps.name found; without owner, names must be globally unique."
  run_once: true

# 6) Prune old per-app route files to avoid stale routes
- name: Find existing per-app edge route files
  ansible.builtin.find:
    paths: "{{ traefik_dynamic_dir }}"
    patterns: "55-edge-route-*.yml"
    file_type: file
  register: _edge_route_existing

- name: Remove existing per-app edge route files
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ _edge_route_existing.files }}"
  when: traefik_edge_routes_prune | default(true)
  notify: restart traefik

# 7) Render one file per app (no owner in filename)
- name: Render per-app edge route files
  ansible.builtin.template:
    src: "dynamic/55-edge-route-app.yml.j2"
    dest: "{{ traefik_dynamic_dir }}/55-edge-route-{{ item.name }}.yml"
    mode: "0644"
  vars:
    edge_app: "{{ item }}"
  loop: "{{ traefik_edge_apps_all }}"
  run_once: true
  notify: restart traefik

# Helpful debug (toggle with -e traefik_edge_routes_debug=true)
- name: Debug rendered edge apps
  ansible.builtin.debug:
    msg:
      - "Route groups: {{ _edge_route_groups }}"
      - "Apps: {{ traefik_edge_apps_all | map(attribute='name') | list }}"
  when: traefik_edge_routes_debug | default(false)
  run_once: true
