services:
  sso-gateway:
    image: {{ sso_gateway_image }}
    container_name: sso-gateway
    restart: unless-stopped

    environment:
      OAUTH2_PROXY_PROVIDER: "keycloak-oidc"
      OAUTH2_PROXY_OIDC_ISSUER_URL: "{{ sso_oidc_issuer_url }}"
      OAUTH2_PROXY_CLIENT_ID: "{{ sso_oidc_client_id }}"
      OAUTH2_PROXY_CLIENT_SECRET: "{{ sso_oidc_client_secret }}"

      OAUTH2_PROXY_REDIRECT_URL: "https://{{ sso_gateway_fqdn }}/oauth2/callback"

      OAUTH2_PROXY_EMAIL_DOMAINS: "{{ sso_email_domains | join(',') }}"
      OAUTH2_PROXY_COOKIE_SECRET: "{{ sso_cookie_secret }}"
      OAUTH2_PROXY_COOKIE_DOMAIN: "{{ sso_cookie_domain }}"
      OAUTH2_PROXY_WHITELIST_DOMAINS: "{{ sso_cookie_domain }}"

      OAUTH2_PROXY_COOKIE_SECURE: "true"
      OAUTH2_PROXY_COOKIE_SAMESITE: "lax"
      OAUTH2_PROXY_REVERSE_PROXY: "true"

      # ForwardAuth headers
      OAUTH2_PROXY_SET_XAUTHREQUEST: "true"
      OAUTH2_PROXY_PASS_AUTHORIZATION_HEADER: "true"
      OAUTH2_PROXY_PASS_ACCESS_TOKEN: "true"

      # We are not proxying to an upstream app; we only act as auth gateway
      OAUTH2_PROXY_UPSTREAMS: "static://200"
      OAUTH2_PROXY_HTTP_ADDRESS: "0.0.0.0:4180"

{% if sso_allowed_groups is defined and (sso_allowed_groups | length) > 0 %}
      # Require group claim (you must map groups in Keycloak token mappers)
      OAUTH2_PROXY_ALLOWED_GROUPS: "{{ sso_allowed_groups | join(',') }}"
{% endif %}

    networks:
      - {{ sso_docker_network }}

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sso.rule=Host(`{{ sso_gateway_fqdn }}`)"
      - "traefik.http.routers.sso.entrypoints={{ sso_gateway_traefik_entrypoint }}"
      - "traefik.http.routers.sso.tls=true"
      - "traefik.http.routers.sso.tls.certresolver={{ sso_gateway_traefik_certresolver }}"
      - "traefik.http.services.sso.loadbalancer.server.port=4180"

networks:
  {{ sso_docker_network }}:
    external: true
